---
import fs from 'node:fs/promises';
import path from 'node:path';
import { type CollectionEntry, getCollection, render } from 'astro:content';
import BlogPost from '../../layouts/BlogPost.astro';

export async function getStaticPaths() {
	const posts = await getCollection('blog');
	return posts.map((post) => ({
		params: { slug: post.id },
		props: post,
	}));
}
type Props = CollectionEntry<'blog'>;

const post = Astro.props;
const { Content, headings } = await render(post);

let effectiveUpdatedDate = post.data.updatedDate;
if (!effectiveUpdatedDate) {
	try {
		const toLocalDateKey = (d: Date) => {
			const y = d.getFullYear();
			const m = String(d.getMonth() + 1).padStart(2, '0');
			const day = String(d.getDate()).padStart(2, '0');
			return `${y}-${m}-${day}`;
		};

		const blogDir = path.resolve(process.cwd(), 'src', 'content', 'blog');
		const id = post.id;
		const candidates = id.endsWith('.md') || id.endsWith('.mdx') ? [id] : [`${id}.md`, `${id}.mdx`];
		let mtime;
		for (const rel of candidates) {
			try {
				const stat = await fs.stat(path.join(blogDir, rel));
				mtime = stat.mtime;
				break;
			} catch {
				// try next candidate
			}
		}
		if (!mtime) throw new Error('No source file found for entry');
		if (toLocalDateKey(mtime) > toLocalDateKey(post.data.pubDate)) {
			effectiveUpdatedDate = mtime;
		}
	} catch {
		// Ignore stat errors; fall back to frontmatter behavior.
	}
}
---

<BlogPost {...post.data} updatedDate={effectiveUpdatedDate} headings={headings}>
	<Content />
</BlogPost>
